USE [BolsaTrabajo]
GO
/****** Object:  StoredProcedure [dbo].[pr_IATFiltrarServicios]    Script Date: 09/23/2013 15:56:16 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER PROCEDURE [dbo].[pr_IATFiltrarServicios]
@iId_Provincia int,
@iId_TipoServicio int,
@iId_CategoriaServicio int,
@iCod_Error int OUTPUT
AS
DECLARE @primeratabla table(Id_Persona int,Nom_Persona varchar(30),Apellido1 varchar(30),Apellido2 varchar(30),Num_Cedula varchar(20),Fec_Nacimiento date,Sexo char(1),Pasatiempos varchar(300),FK_IdUsuario int,FK_IdDistrito int,Id_Servicio int,Nom_Servicio varchar(50),Descripcion varchar(200),FK_IdCategoriaServicio int, FK_IdTipoServicio int, FK_IdPersona int,Id_Contacto int,Detalle varchar(80),FK_IdTipoContacto int,FK_IdUsuario2 int);
INSERT INTO @primeratabla 
	SELECT *
	FROM IATPersona AS persona
	INNER JOIN IATServicio AS servicios
	ON servicios.FK_IdPersona = persona.Id_Persona
	INNER JOIN IATContacto AS contacto
	ON (persona.FK_IdUsuario = contacto.FK_IdUsuario) AND (contacto.FK_IdTipoContacto = 1)
	WHERE (@iId_TipoServicio IS NULL OR [servicios].FK_IdTipoServicio = @iId_TipoServicio) AND (@iId_CategoriaServicio IS NULL OR [servicios].FK_IdCategoriaServicio = @iId_CategoriaServicio)
DECLARE @segundatabla table(Id_Canton int,Nom_Canton varchar(30),FK_IdProvincia int,Id_Distrito int, Nom_Distrito varchar(30),FK_IdCanton int); 
INSERT INTO @segundatabla
	SELECT * 
		FROM  IATCanton AS canton
		INNER JOIN IATDistrito AS distrito
		ON canton.Id_Canton = distrito.FK_IdCanton
		WHERE @iId_Provincia IS NULL OR [canton].FK_IdProvincia = @iId_Provincia
SELECT * 
	FROM @primeratabla as SXP
	  INNER JOIN @segundatabla as PXP
	  ON SXP.FK_IdDistrito =  PXP.Id_Distrito
SELECT @iCod_Error=@@ERROR